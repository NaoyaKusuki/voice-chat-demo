<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Full-Duplex Voice Chat</title>
  <style>
    body { font-family: sans-serif; margin: 20px; text-align: center; }
    h1 { font-size: 20px; margin-bottom: 10px; }

    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    button:hover { transform: scale(1.05); }

    #startButton { background-color: #006FC5; color: white; }

    #micButton {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
    }

    #micIndicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #006FC5;
      transition: background-color 0.3s ease, opacity 0.3s ease;
    }

    /* üî¥ „Éû„Ç§„ÇØONÊôÇ„Å´ÁÇπÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    #micIndicator.on {
      background-color: #ff3b3b;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ‚ö™Ô∏è „Éû„Ç§„ÇØOFFÊôÇ */
    #micIndicator.off {
      background-color: #777;
      opacity: 0.8;
      animation: none;
    }

  </style>
</head>
<body>
  <h1>Full-Duplex Voice Chat Demo_OpenAI RealtimeAPIÔºàUI„Ç∑„É≥„Éó„É´ver.Ôºâ</h1>
  <button id="startButton">Start Chat</button>
  <button id="micButton" class="on">
    <div id="micIndicator" class="on"></div>
    <span id="micLabel">„Éû„Ç§„ÇØON</span>
  </button>

  <script>
    let pc;
    let localStream;
    let micEnabled = true;
    let dataChannel;

    async function startChat() {
      const res = await fetch("/api/session");
      const data = await res.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      pc = new RTCPeerConnection();

      // AI„ÅÆÈü≥Â£∞Âá∫Âäõ
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

      // „Éû„Ç§„ÇØÂÖ•Âäõ„ÇíÂèñÂæó
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // DataChannelË®≠ÂÆö
      dataChannel = pc.createDataChannel("oai-events");

      dataChannel.onopen = () => {
        console.log("‚úÖ DataChannel opened");

        // üéØ ÂàùÂõûAIÁô∫Ë©±Ôºàtext + audio‰∏°ÊñπÊåáÂÆö„ÅåÈáçË¶ÅÔºâ
        dataChannel.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio", "text"],
            instructions: "„Åì„Çì„Å´„Å°„ÅØÔºÅÈü≥Â£∞„Åß„ÅäË©±„Åó„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
          },
        }));

        alert("‚úÖ AI„Å®„ÅÆÈü≥Â£∞„ÉÅ„É£„ÉÉ„Éà„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºÅ");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);
    }

    // „Éû„Ç§„ÇØON/OFFÂàá„ÇäÊõø„Åà
    function toggleMic() {
      if (!localStream) return;

      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = micEnabled;
      });

      const micIndicator = document.getElementById("micIndicator");
      const micLabel = document.getElementById("micLabel");

      if (micEnabled) {
        micLabel.textContent = "„Éû„Ç§„ÇØON";
        micIndicator.className = "on";
      } else {
        micLabel.textContent = "„Éû„Ç§„ÇØOFF";
        micIndicator.className = "off";
      }
    }

    document.getElementById("startButton").addEventListener("click", startChat);
    document.getElementById("micButton").addEventListener("click", toggleMic);
  </script>
</body>
</html>
