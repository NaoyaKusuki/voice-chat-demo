<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Voice Chat Demo (OpenAI Realtime API)</title>
</head>
<body>
  <h1>ğŸ¤ Voice Chat Demo (OpenAI Realtime API)</h1>
  <button id="startButton">Start Chat</button>

  <script>
    async function startChat() {
      const response = await fetch("/api/session");
      const data = await response.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      const pc = new RTCPeerConnection();

      // éŸ³å£°å‡ºåŠ›
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);

      pc.ontrack = (event) => {
        console.log("ğŸ§ Audio track received");
        audioEl.srcObject = event.streams[0];
      };

      // éŸ³å£°å…¥åŠ›
      const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
      for (const track of ms.getTracks()) {
        pc.addTrack(track, ms);
      }

      // DataChannelã§ãƒˆãƒªã‚¬ãƒ¼ã‚’é€ã‚‹
      const dc = pc.createDataChannel("oai-events");
      dc.onopen = () => {
        console.log("âœ… DataChannel opened");
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿæ—¥æœ¬èªã§è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
          }
        }));
        alert("âœ… AIã¨ã®éŸ³å£°é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ï¼ˆè©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼‰");
      };
      dc.onmessage = (event) => console.log("ğŸ“©", event.data);

      // Offerä½œæˆ
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // OpenAIå´ã«SDPã‚’é€ä¿¡ã—ã¦Answerã‚’å–å¾—
      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const response2 = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = {
        type: "answer",
        sdp: await response2.text()
      };
      await pc.setRemoteDescription(answer);
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
