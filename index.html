<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime + Debug (å­—å¹•æ¤œè¨¼)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #subtitle { background: #f1f8e9; padding: 12px; border-radius: 8px; margin-top: 20px; min-height: 40px; }
  </style>
</head>
<body>
  <h1>ğŸ§ Realtime AI Chatï¼ˆå­—å¹•ãƒ‡ãƒãƒƒã‚°ä¸­ï¼‰</h1>
  <button id="startButton">Start Chat</button>
  <div id="subtitle">(AIã®ç™ºè©±å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div>

  <script>
    async function startChat() {
      const subtitleBox = document.getElementById("subtitle");
      const res = await fetch("/api/session");
      const data = await res.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      const pc = new RTCPeerConnection();
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // DataChannelè¨­å®š
      const dc = pc.createDataChannel("oai-events");

      dc.onmessage = (event) => {
        console.log("ğŸ“© DataChannel message:", event.data);
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "response.output_text.delta") {
            subtitleBox.textContent += msg.delta;
          }
          if (msg.type === "response.completed") {
            subtitleBox.textContent += "\n";
          }
        } catch (e) {
          // JSONã§ãªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¨˜éŒ²
          console.log("éJSONãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", event.data);
        }
      };

      dc.onopen = () => {
        console.log("âœ… DataChannel opened");
        // å¿œç­”ãƒˆãƒªã‚¬ãƒ¼
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio", "text"],
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼éŸ³å£°ã¨åŒæ™‚ã«ãƒ†ã‚­ã‚¹ãƒˆã‚‚å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚",
          },
        }));
        alert("âœ… æ¥ç¶šå®Œäº†ï¼AIãŒè©±ã™ã¨ãã«å­—å¹•ãŒå‡ºã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
