<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Chat Demo (OpenAI Realtime API)</title>
</head>
<body>
  <h1>ğŸ¤ Voice Chat Demo (OpenAI Realtime API)</h1>
  <button id="startButton">Start Chat</button>

  <script>
    async function startChat() {
      const response = await fetch("/api/session");
      const data = await response.json();

      const pc = new RTCPeerConnection();
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);

      // å—ä¿¡éŸ³å£°ã‚’å†ç”Ÿ
      pc.ontrack = (event) => {
        const stream = event.streams[0];
        console.log("ğŸ§ Received audio stream:", stream);
        audioEl.srcObject = stream;
      };

      // ãƒã‚¤ã‚¯å…¥åŠ›
      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      for (const track of localStream.getTracks()) {
        pc.addTrack(track, localStream);
      }

      // DataChannelã§AIã«æŒ‡ç¤ºã‚’é€ã‚‹
      const dc = pc.createDataChannel("oai-events");
      dc.onmessage = (event) => console.log("ğŸ“© AI Event:", event.data);
      dc.onopen = () => {
        console.log("âœ… DataChannel opened");
        // æ˜ç¤ºçš„ã«ç™ºè©±ã‚’ãƒˆãƒªã‚¬ãƒ¼
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿï¼ˆæ—¥æœ¬èªã§è©±ã—ã¦ãã ã•ã„ï¼‰"
          }
        }));
        alert("âœ… AIã¨ã®éŸ³å£°é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ï¼ˆãƒã‚¤ã‚¯ã«è©±ã—ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ï¼‰");
      };

      // SDPã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆ
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      // éŸ³å£°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’wavã«æŒ‡å®šï¼ˆPCMã‚ˆã‚Šå®‰å®šï¼‰
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${data.client_secret.value}`,
          "Content-Type": "application/sdp",
          "Accept": "application/sdp",
        },
        body: offer.sdp.replace("opus/48000/2", "wav") // ã“ã“ã§å‡ºåŠ›ã‚’wavã«å¤‰æ›´
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text(),
      };
      await pc.setRemoteDescription(answer);
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
