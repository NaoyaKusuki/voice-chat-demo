<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Chat Demo (OpenAI Realtime API)</title>
</head>
<body>
  <h1>ğŸ¤ Voice Chat Demo (OpenAI Realtime API)</h1>
  <button id="startButton">Start Chat</button>

  <script>
    async function startChat() {
      const response = await fetch("/api/session");
      const data = await response.json();

      const pc = new RTCPeerConnection();
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);

      pc.ontrack = (event) => {
        audioEl.srcObject = event.streams[0];
      };

      const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
      for (const track of ms.getTracks()) {
        pc.addTrack(track, ms);
      }

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${data.client_secret.value}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text()
      };
      await pc.setRemoteDescription(answer);

      // âœ… ã“ã“ãŒé‡è¦ï¼šAIã«ç™ºè©±ã‚’ä¿ƒã™ãƒˆãƒªã‚¬ãƒ¼ã‚’é€ã‚‹
      const dc = pc.createDataChannel("oai-events");
      dc.onopen = () => {
        dc.send(JSON.stringify({ type: "response.create" }));
        alert("âœ… AIã¨ã®éŸ³å£°é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ï¼ˆè©±ã—ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ï¼‰");
      };
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
