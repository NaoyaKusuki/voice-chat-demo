<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Full-Duplex Voice Chat</title>
  <style>
    body { font-family: sans-serif; margin: 20px; text-align: center; }
    h1 { font-size: 20px; margin-bottom: 10px; }

    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    button:hover { transform: scale(1.05); }

    #startButton { background-color: #4caf50; color: white; }

    #micButton {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
    }

    #micIndicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #ccc;
      transition: background-color 0.3s ease, opacity 0.3s ease;
    }

    #micIndicator.on {
      background-color: #ff3b3b;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    #micIndicator.off {
      background-color: #777;
      opacity: 0.8;
      animation: none;
    }
  </style>
</head>

<body>
  <!-- ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const correctPassword = "0303";
    const input = prompt("ã“ã®ãƒ‡ãƒ¢ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
    if (input !== correctPassword) {
      document.body.innerHTML = "<h2>ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚</h2><p>æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>";
      throw new Error("Access denied");
    }
  </script>

  <h1>ğŸ§ Full-Duplex Voice Chatï¼ˆãƒã‚¤ã‚¯åˆ¶å¾¡ä»˜ãï¼‰</h1>
  <button id="startButton">Start Chat</button>
  <button id="micButton" class="on">
    <div id="micIndicator" class="on"></div>
    <span id="micLabel">ãƒã‚¤ã‚¯ON</span>
  </button>

  <script>
    let pc;
    let localStream;
    let micEnabled = true;
    let dataChannel;

    async function startChat() {
      const res = await fetch("/api/session");
      const data = await res.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      pc = new RTCPeerConnection();

      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      dataChannel = pc.createDataChannel("oai-events");
      dataChannel.onopen = () => {
        console.log("âœ… DataChannel opened");
        dataChannel.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio", "text"],
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼éŸ³å£°ã§ãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã€‚",
          },
        }));
        alert("âœ… AIã¨ã®éŸ³å£°ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸï¼");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);
    }

    function toggleMic() {
      if (!localStream) return;

      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = micEnabled;
      });

      const micIndicator = document.getElementById("micIndicator");
      const micLabel = document.getElementById("micLabel");

      if (micEnabled) {
        micLabel.textContent = "ãƒã‚¤ã‚¯ON";
        micIndicator.className = "on";
      } else {
        micLabel.textContent = "ãƒã‚¤ã‚¯OFF";
        micIndicator.className = "off";
      }
    }

    document.getElementById("startButton").addEventListener("click", startChat);
    document.getElementById("micButton").addEventListener("click", toggleMic);
  </script>
</body>
</html>
