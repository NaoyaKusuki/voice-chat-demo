<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Full-Duplex Test</title>
</head>
<body>
  <h1>ğŸ§ Full-Duplex Realtime Test</h1>
  <button id="startButton">Start Full-Duplex Chat</button>

  <script>
    async function startChat() {
      const res = await fetch("/api/session");
      const data = await res.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      const pc = new RTCPeerConnection();

      // éŸ³å£°å‡ºåŠ›
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = (event) => {
        audioEl.srcObject = event.streams[0];
      };

      // ãƒã‚¤ã‚¯å…¥åŠ›
      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // DataChannelã§åˆ¶å¾¡
      const dc = pc.createDataChannel("oai-events");
      dc.onopen = () => {
        console.log("âœ… DataChannel opened");
        // åˆå›ã®AIç™ºè©±ã‚’ãƒˆãƒªã‚¬ãƒ¼
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼åŒæ™‚ã«è©±ã—ã¦ã‚‚å¿œç­”ã§ãã¾ã™ã€‚"
          }
        }));
        alert("âœ… Full-Duplexãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼AIã¨åŒæ™‚ã«è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text()
      };
      await pc.setRemoteDescription(answer);
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
