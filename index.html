<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Chat Demo</title>
</head>
<body>
  <h1>ğŸ¤ Voice Chat Demo (OpenAI Realtime API)</h1>
  <button id="startButton">Start Chat</button>

  <script>
    async function startChat() {
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä¸€æ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
      const response = await fetch("/api/session");
      const data = await response.json();

      // WebRTCã®æ¥ç¶šã‚’ä½œæˆ
      const pc = new RTCPeerConnection();
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);

      // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³å£°ã®å‡ºåŠ›è¨­å®š
      pc.ontrack = (event) => {
        audioEl.srcObject = event.streams[0];
      };

      // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒã‚¤ã‚¯éŸ³å£°ã‚’å–å¾—
      const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
      for (const track of ms.getTracks()) {
        pc.addTrack(track, ms);
      }

      // Realtime APIã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šè¨­å®š
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // OpenAIå´ã®Realtimeã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨æ¥ç¶š
      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${data.client_secret.value}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text()
      };
      await pc.setRemoteDescription(answer);

      alert("âœ… AIã¨ã®éŸ³å£°é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ï¼ˆãƒã‚¤ã‚¯ã«è©±ã—ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ï¼‰");
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
