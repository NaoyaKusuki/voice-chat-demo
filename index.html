<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Full-Duplex + AIå­—å¹•</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #subtitle {
      margin-top: 20px;
      background: #f1f8e9;
      padding: 12px;
      border-radius: 8px;
      font-size: 18px;
      line-height: 1.5;
      min-height: 40px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ Full-Duplex Realtime Chatï¼ˆAIå­—å¹•ã¤ãï¼‰</h1>
  <button id="startButton">Start Chat</button>
  <div id="subtitle">(AIã®ç™ºè©±å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div>

  <script>
    async function startChat() {
      const subtitleBox = document.getElementById("subtitle");

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
      const res = await fetch("/api/session");
      const data = await res.json();
      const EPHEMERAL_KEY = data.client_secret.value;

      const pc = new RTCPeerConnection();

      // å‡ºåŠ›éŸ³å£°
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);
      pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

      // ãƒã‚¤ã‚¯å…¥åŠ›
      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // DataChannelã§ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
      const dc = pc.createDataChannel("oai-events");

      dc.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);

          // ğŸ¯ ã“ã“ã‚’ä¿®æ­£ï¼šaudio_transcript.delta ã‚’æ¤œå‡ºã—ã¦è¡¨ç¤º
          if (msg.type === "response.audio_transcript.delta") {
            subtitleBox.textContent += msg.delta;
          }

          // å‡ºåŠ›å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã§æ”¹è¡Œ
          if (msg.type === "response.audio_transcript.done") {
            subtitleBox.textContent += "\n";
          }

        } catch (e) {
          console.log("éJSONãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", event.data);
        }
      };

      dc.onopen = () => {
        console.log("âœ… DataChannel opened");
        dc.send(JSON.stringify({
          type: "response.create",
          response: {
            modalities: ["audio", "text"],
            instructions: "ã“ã‚“ã«ã¡ã¯ï¼éŸ³å£°ã¨åŒæ™‚ã«å­—å¹•ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚‚å‡ºã—ã¦ãã ã•ã„ã€‚"
          }
        }));
        alert("âœ… AIã¨ã®éŸ³å£°ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ï¼ˆå­—å¹•ã¤ãï¼‰");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";

      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });

      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);
    }

    document.getElementById("startButton").addEventListener("click", startChat);
  </script>
</body>
</html>
